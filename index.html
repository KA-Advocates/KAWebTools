<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Prototype PO processor</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.6.0/css/bulma.min.css">
    <script type="text/javascript" src="https://unpkg.com/gettext-parser-dist@0.0.2/dist.js"></script>
    <script type="text/javascript" src="https://unpkg.com/text-encoding@0.6.4/lib/encoding.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://unpkg.com/lodash@4.17.4/lodash.js"></script>


    <script type="text/javascript" src="POParser.js"></script>
    <script type="text/javascript" src="POExporter.js"></script>
    <script type="text/javascript" src="FileProcessor.js"></script>
  </head>
  <body>
  <section class="section">
    <div class="container">
      <h1 class="title">
        Prototype PO processor
      </h1>
      <div class="file has-name">
          <label class="file-label">
            <input class="file-input" type="file" name="resume" onchange="onFileSelected(this.files)">
            <span class="file-cta">
              <span class="file-icon">
                <i class="fa fa-upload"></i>
              </span>
              <span class="file-label">
                Choose a fileâ€¦
              </span>
            </span>
            <span class="file-name">
              Please select PO file!
            </span>
          </label>
        </div>
    </div>
    <div class="spacer" style="height: 40px;"></div>
    <div class="container">
        <p class="subtitle" id="progressMsg">Please select a .po file to auto-translate!</p>
        <progress id="loadProgress" class="progress is-primary is-medium" value="0" max="100">0%</progress>
        <div id="results">
        </div>
    </div>
  </section>

  <script type="text/javascript">

    /**
     * This is called for untranslated strings.
     * It will not be called for already-translated strings
     * 
     * Must return the translated string if it can be translated.
     * Must return null if the string can't be auto-translated.
     */
    function tryAutotranslate(english, translated) {
        // Formula
        let isFormulaOnly = english.match(/^\$[^\$]+\$(\s|\\n)*$/g);
        let containsText = _.includes(english, "\\text{");

        if(isFormulaOnly && !containsText) {
            return english; // Nothing to translate
        }

        // Can't autotranslate
        return null;
    }

    /**
     * In the UI, show that we have autotranslated something.
     * Modify this if it doesn't look good in the UI ;-)
     */
    function showAutotranslatedString(english, translated) {
        $("#results").append(`<p>Auto-translated <em>${english}</em> to <em>${translated}</em></p>`)
    }

    function handleTranslations(po) {
        let autoTranslatedCount = 0;
        for (let trans of Object.values(po)) {
            let engl = trans.msgid;
            // Ignore everything but first translations
            let translation = trans.msgstr === undefined ? "" : trans.msgstr[0];
            // Does string have at least one translation?
            let hasTranslations = translation != "";
            // Try to auto-translate if it has any translations
            if(!hasTranslations) {
                let autotranslation = tryAutotranslate(engl, translation);
                if(autotranslation) {
                    // Insert into PO data structure (will be exported later)
                    trans.msgstr = [autotranslation];
                    // Update UI
                    showAutotranslatedString(engl, autotranslation);
                    // Update stats
                    autoTranslatedCount++;
                }
            }
        }
        return autoTranslatedCount;
     }

    /**
     * Handle a parsed PO object
     */
    function handlePOObject(filename, po) {
        let autoTranslatedCount = 0;
        // Remove previous results
        $("#results").empty();
        // Go through PO file and try to auto-translate untranslated strings.
        autoTranslatedCount += handleTranslations(po.translations['']);
        $("#progressMsg").text(`Auto-translated ${autoTranslatedCount} strings`)
        // Export to new PO
        downloadFile(new POExporter(po).compile(),
            filename + ".translated.po",
            'text/x-gettext-translation')
    }

      /**
       * This is called when the user selected a file
       * It reads the file (in chunks)
       */
    function onFileSelected(files) {
        let file = files[0];
        let pop = new POParser();
        $("#progressMsg").text(`Loading ${file.name} ...`)

        processLocalFileInChunks(file, (chunk, currentChunk, nchunks) => { // On chunk
            pop._lexer(chunk);
            // Update progress
            $("#loadProgress").attr("value", 100 * (currentChunk / nchunks))
        }, () => { // On finished
            let po = pop._finalize();
            $("#progressMsg").text("Auto-translating... ")
            handlePOObject(file.name, po);
        }, (err) => { // Error while reading file
            $("#progressMsg").text(`Read error: ${err}`);
        })
    }
  </script>
  </body>
</html>
